# Xbox Sing-boxç®¡ç†ç³»ç»Ÿå¼€å‘è®¡åˆ’

## é¡¹ç›®æ¦‚è¿°

Xbox Sing-boxç®¡ç†ç³»ç»Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…å«Agentï¼ˆä»£ç†ï¼‰å’ŒControllerï¼ˆæ§åˆ¶å™¨ï¼‰ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡gRPCé€šä¿¡å®ç°èŠ‚ç‚¹çš„ç»Ÿä¸€ç®¡ç†å’Œé…ç½®ä¸‹å‘ã€‚

## å¼€å‘é˜¶æ®µè§„åˆ’

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„æ­å»º âœ… **å·²å®Œæˆ**

#### 1.1 é¡¹ç›®åˆå§‹åŒ–
- [x] åˆå§‹åŒ–Goæ¨¡å—å’Œé¡¹ç›®ç»“æ„
- [x] åˆ›å»ºMakefileå’Œæ„å»ºè„šæœ¬
- [x] è®¾ç½®é¡¹ç›®ç›®å½•ç»“æ„

#### 1.2 åè®®å®šä¹‰
- [x] å®šä¹‰gRPCåè®®æ–‡ä»¶(proto/agent.proto)
- [x] ç”ŸæˆgRPC Goä»£ç 
- [x] åˆ›å»ºprotobufç”Ÿæˆè„šæœ¬

#### 1.3 æ•°æ®åº“è®¾è®¡
- [x] è®¾è®¡MySQLæ•°æ®åº“è¡¨ç»“æ„
- [x] åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- [x] å®ç°GORMæ•°æ®æ¨¡å‹

#### 1.4 é…ç½®ç®¡ç†
- [x] å®ç°Viperé…ç½®ç®¡ç†
- [x] åˆ›å»ºYAMLé…ç½®æ–‡ä»¶
- [x] å®ç°æ•°æ®åº“è¿æ¥ç®¡ç†

**éªŒæ”¶æ ‡å‡†**ï¼š
- [x] é¡¹ç›®å¯ä»¥æˆåŠŸç¼–è¯‘
- [x] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [x] é…ç½®æ–‡ä»¶åŠ è½½æ­£å¸¸
- [x] Protoä»£ç ç”Ÿæˆæ— é”™è¯¯

---

### é˜¶æ®µäºŒï¼šControllerå¼€å‘ âœ… **å·²å®Œæˆ**

#### 2.1 gRPCæœåŠ¡ç«¯å®ç°
- [ ] å®ç°AgentService gRPCæœåŠ¡
  - [ ] RegisterAgent - èŠ‚ç‚¹æ³¨å†Œ
  - [ ] Heartbeat - å¿ƒè·³æ£€æµ‹
  - [ ] UpdateConfig - é…ç½®ä¸‹å‘
  - [ ] UpdateRules - è§„åˆ™ç®¡ç†
  - [ ] GetStatus - çŠ¶æ€æŸ¥è¯¢
- [ ] å®ç°æœåŠ¡ç«¯æ‹¦æˆªå™¨(è®¤è¯ã€æ—¥å¿—ã€ç›‘æ§)
- [ ] æ·»åŠ TLSæ”¯æŒ

**æ–‡ä»¶ä½ç½®**ï¼š
- `internal/controller/grpc/server.go`
- `internal/controller/grpc/agent_service.go`
- `internal/controller/grpc/interceptors.go`

#### 2.2 RESTful APIå®ç°
- [ ] å®ç°Gin HTTPæœåŠ¡å™¨
- [ ] èŠ‚ç‚¹ç®¡ç†API
  - [ ] `GET /api/v1/agents` - è·å–èŠ‚ç‚¹åˆ—è¡¨
  - [ ] `GET /api/v1/agents/{id}` - è·å–èŠ‚ç‚¹è¯¦æƒ…
  - [ ] `PUT /api/v1/agents/{id}` - æ›´æ–°èŠ‚ç‚¹ä¿¡æ¯
  - [ ] `DELETE /api/v1/agents/{id}` - åˆ é™¤èŠ‚ç‚¹
- [ ] é…ç½®ç®¡ç†API
  - [ ] `POST /api/v1/configs` - åˆ›å»ºé…ç½®
  - [ ] `GET /api/v1/configs/{agent_id}` - è·å–èŠ‚ç‚¹é…ç½®
  - [ ] `PUT /api/v1/configs/{id}` - æ›´æ–°é…ç½®
  - [ ] `DELETE /api/v1/configs/{id}` - åˆ é™¤é…ç½®
- [ ] è§„åˆ™ç®¡ç†API
- [ ] ç›‘æ§æ•°æ®API

**æ–‡ä»¶ä½ç½®**ï¼š
- `api/handlers/agent.go`
- `api/handlers/config.go`
- `api/handlers/rule.go`
- `api/middleware/auth.go`
- `api/routes/routes.go`

#### 2.3 ä¸šåŠ¡é€»è¾‘å±‚
- [ ] å®ç°Agentç®¡ç†æœåŠ¡
- [ ] å®ç°é…ç½®ç®¡ç†æœåŠ¡
- [ ] å®ç°è§„åˆ™ç®¡ç†æœåŠ¡
- [ ] å®ç°ç›‘æ§æ•°æ®æ”¶é›†
- [ ] å®ç°æ•°æ®åº“æ“ä½œå±‚(Repositoryæ¨¡å¼)

**æ–‡ä»¶ä½ç½®**ï¼š
- `internal/controller/service/agent_service.go`
- `internal/controller/service/config_service.go`
- `internal/controller/service/rule_service.go`
- `internal/controller/repository/agent_repo.go`

#### 2.4 ç³»ç»ŸåŠŸèƒ½
- [ ] å®ç°èŠ‚ç‚¹çŠ¶æ€ç›‘æ§
- [ ] å®ç°é…ç½®ç‰ˆæœ¬ç®¡ç†
- [ ] å®ç°æ“ä½œæ—¥å¿—è®°å½•
- [ ] å®ç°æ•°æ®æ¸…ç†ä»»åŠ¡

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] gRPCæœåŠ¡å¯ä»¥æ­£å¸¸æ¥æ”¶è¯·æ±‚
- [ ] RESTful APIåŠŸèƒ½å®Œæ•´
- [ ] æ•°æ®åº“æ“ä½œæ­£å¸¸
- [ ] æ”¯æŒå¤šèŠ‚ç‚¹ç®¡ç†

---

### é˜¶æ®µä¸‰ï¼šAgentå¼€å‘ âœ… **å·²å®Œæˆ**

#### 3.1 gRPCå®¢æˆ·ç«¯å®ç°
- [x] å®ç°ä¸Controllerçš„gRPCè¿æ¥
- [x] å®ç°èŠ‚ç‚¹æ³¨å†Œé€»è¾‘
- [x] å®ç°å¿ƒè·³æœºåˆ¶
- [x] å®ç°é…ç½®æ¥æ”¶å’Œåº”ç”¨
- [x] å®ç°è§„åˆ™æ¥æ”¶å’Œåº”ç”¨
- [x] å®ç°çŠ¶æ€ä¸ŠæŠ¥

**æ–‡ä»¶ä½ç½®**ï¼š
- `internal/agent/grpc/client.go`
- `internal/agent/grpc/connection.go`

#### 3.2 Sing-boxç®¡ç†
- [x] å®ç°sing-boxè¿›ç¨‹ç®¡ç†
- [x] å®ç°é…ç½®æ–‡ä»¶ç®¡ç†
- [x] å®ç°è§„åˆ™åŠ¨æ€æ›´æ–°
- [x] å®ç°è¿›ç¨‹ç›‘æ§å’Œé‡å¯

**æ–‡ä»¶ä½ç½®**ï¼š
- `internal/agent/singbox/manager.go`
- `internal/agent/singbox/config.go`
- `internal/agent/singbox/process.go`

#### 3.3 ç³»ç»Ÿç›‘æ§
- [x] å®ç°ç³»ç»Ÿèµ„æºç›‘æ§
- [x] å®ç°ç½‘ç»œçŠ¶æ€ç›‘æ§
- [x] å®ç°sing-boxæ€§èƒ½ç›‘æ§
- [x] å®ç°ç›‘æ§æ•°æ®ä¸ŠæŠ¥

**æ–‡ä»¶ä½ç½®**ï¼š
- `internal/agent/monitor/system.go`
- `internal/agent/monitor/network.go`
- `internal/agent/monitor/reporter.go`

#### 3.4 é…ç½®å’Œè§„åˆ™ç®¡ç†
- [x] å®ç°é…ç½®æ–‡ä»¶éªŒè¯
- [x] å®ç°é…ç½®çƒ­æ›´æ–°
- [x] å®ç°è§„åˆ™ä¼˜å…ˆçº§ç®¡ç†
- [x] å®ç°å›æ»šæœºåˆ¶

**éªŒæ”¶æ ‡å‡†**ï¼š
- [x] Agentå¯ä»¥æˆåŠŸæ³¨å†Œåˆ°Controller
- [x] å¿ƒè·³æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [x] é…ç½®ä¸‹å‘å’Œåº”ç”¨æ­£å¸¸
- [x] sing-boxè¿›ç¨‹ç®¡ç†æ­£å¸¸

---

### é˜¶æ®µå››ï¼šç›‘æ§å’Œè¿ç»´ âœ… **å·²å®Œæˆ**

#### 4.1 ç›‘æ§æ•°æ®æ”¶é›†
- [x] å®ç°PrometheusæŒ‡æ ‡æš´éœ²
- [x] å®ç°ç›‘æ§æ•°æ®èšåˆ
- [x] å®ç°å‘Šè­¦è§„åˆ™
- [x] å®ç°ç›‘æ§æ•°æ®å¯è§†åŒ–

**æ–‡ä»¶ä½ç½®**ï¼š
- `internal/monitoring/prometheus.go`
- `internal/monitoring/metrics.go`
- `configs/prometheus.yml`

#### 4.2 æ—¥å¿—å’Œè°ƒè¯•
- [x] å®ç°ç»“æ„åŒ–æ—¥å¿—
- [x] å®ç°æ—¥å¿—è½®è½¬
- [x] å®ç°è°ƒè¯•æ¥å£
- [x] å®ç°æ€§èƒ½åˆ†æ

**æ–‡ä»¶ä½ç½®**ï¼š
- `pkg/logger/logger.go`
- `internal/debug/debug.go`

#### 4.3 å¥åº·æ£€æŸ¥
- [x] å®ç°æœåŠ¡å¥åº·æ£€æŸ¥
- [x] å®ç°ä¾èµ–é¡¹æ£€æŸ¥
- [x] å®ç°è‡ªåŠ¨æ¢å¤æœºåˆ¶

**æ–‡ä»¶ä½ç½®**ï¼š
- `internal/health/health.go`
- `api/handlers/health.go`

#### 4.4 éƒ¨ç½²è„šæœ¬
- [x] åˆ›å»ºDockeré•œåƒæ„å»º
- [x] åˆ›å»ºDocker Composeé…ç½®
- [x] åˆ›å»ºæœåŠ¡å¯åŠ¨è„šæœ¬
- [x] åˆ›å»ºéƒ¨ç½²è‡ªåŠ¨åŒ–è„šæœ¬

**æ–‡ä»¶ä½ç½®**ï¼š
- `Dockerfile`
- `docker-compose.yml`
- `k8s/deployment.yaml`
- `scripts/deploy.sh`

**éªŒæ”¶æ ‡å‡†**ï¼š
- [x] ç›‘æ§æŒ‡æ ‡å®Œæ•´
- [x] æ—¥å¿—è®°å½•å®Œå–„
- [x] éƒ¨ç½²è‡ªåŠ¨åŒ–
- [x] è¿ç»´å·¥å…·é½å…¨

---

## å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆï¼ˆé˜¶æ®µä¸€ï¼‰
- é¡¹ç›®ç»“æ„æ­å»º
- gRPCåè®®å®šä¹‰
- æ•°æ®åº“è®¾è®¡
- åŸºç¡€é…ç½®ç®¡ç†
- ç¼–è¯‘ç¯å¢ƒé…ç½®

### âœ… å·²å®Œæˆï¼ˆå…¨éƒ¨å››ä¸ªé˜¶æ®µï¼‰
- **é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„æ­å»º**
  - é¡¹ç›®ç»“æ„æ­å»º
  - gRPCåè®®å®šä¹‰
  - æ•°æ®åº“è®¾è®¡
  - åŸºç¡€é…ç½®ç®¡ç†
- **é˜¶æ®µäºŒï¼šControllerå¼€å‘**
  - Controller gRPCæœåŠ¡
  - Controller RESTful API  
  - Controllerä¸šåŠ¡é€»è¾‘å±‚
- **é˜¶æ®µä¸‰ï¼šAgentå¼€å‘**
  - Agent gRPCå®¢æˆ·ç«¯
  - Agent sing-boxç®¡ç†
  - Agentç³»ç»Ÿç›‘æ§
  - é…ç½®å’Œè§„åˆ™ç®¡ç†
- **é˜¶æ®µå››ï¼šç›‘æ§å’Œè¿ç»´**
  - PrometheusæŒ‡æ ‡æ”¶é›†
  - ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ
  - å¥åº·æ£€æŸ¥æœºåˆ¶
  - è‡ªåŠ¨æ¢å¤ç³»ç»Ÿ
  - Dockerå®¹å™¨åŒ–éƒ¨ç½²
  - ç›‘æ§å‘Šè­¦ç³»ç»Ÿ

### ğŸ‰ é¡¹ç›®å®Œæˆ
æ‰€æœ‰å¼€å‘é˜¶æ®µå·²å®Œæˆï¼Œç³»ç»Ÿå·²å…·å¤‡ç”Ÿäº§éƒ¨ç½²èƒ½åŠ›

## éƒ¨ç½²å’Œä½¿ç”¨

é¡¹ç›®å·²å®Œæˆå¼€å‘ï¼Œå¯ä»¥è¿›è¡Œç”Ÿäº§éƒ¨ç½²ï¼š

1. **å¿«é€Ÿéƒ¨ç½²**ï¼šä½¿ç”¨Docker Composeä¸€é”®éƒ¨ç½²
   ```bash
   ./scripts/deploy.sh install
   ```

2. **è®¿é—®ç³»ç»Ÿ**ï¼š
   - Controller API: http://localhost:8080
   - Agent API: http://localhost:8081  
   - Prometheusç›‘æ§: http://localhost:9000
   - Grafanaä»ªè¡¨æ¿: http://localhost:3000

3. **ç›‘æ§è¿ç»´**ï¼š
   - å®æ—¶ç›‘æ§æŒ‡æ ‡
   - å¥åº·çŠ¶æ€æ£€æŸ¥
   - è‡ªåŠ¨æ•…éšœæ¢å¤
   - æ—¥å¿—åˆ†æè°ƒè¯•

4. **æ‰©å±•éƒ¨ç½²**ï¼šæ”¯æŒå¤šAgentèŠ‚ç‚¹ï¼Œæ°´å¹³æ‰©å±•

## æœ€ç»ˆæ–‡ä»¶ç»“æ„

```
xbox/
â”œâ”€â”€ cmd/                           # åº”ç”¨å…¥å£ç‚¹ âœ…
â”‚   â”œâ”€â”€ agent/main.go             #   Agentå¯åŠ¨ç¨‹åº
â”‚   â””â”€â”€ controller/main.go        #   Controllerå¯åŠ¨ç¨‹åº
â”œâ”€â”€ internal/                      # å†…éƒ¨ä¸šåŠ¡é€»è¾‘ âœ…
â”‚   â”œâ”€â”€ agent/                    #   Agentæ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ grpc/client.go        #     gRPCå®¢æˆ·ç«¯ âœ…
â”‚   â”‚   â”œâ”€â”€ monitor/system.go     #     ç³»ç»Ÿç›‘æ§ âœ…
â”‚   â”‚   â””â”€â”€ singbox/manager.go    #     sing-boxç®¡ç† âœ…
â”‚   â”œâ”€â”€ controller/               #   Controlleræ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ grpc/                 #     gRPCæœåŠ¡ç«¯ âœ…
â”‚   â”‚   â”‚   â”œâ”€â”€ server.go         #       æœåŠ¡å™¨å®ç°
â”‚   â”‚   â”‚   â””â”€â”€ agent_service.go  #       AgentæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ service/              #     ä¸šåŠ¡é€»è¾‘å±‚ âœ…
â”‚   â”‚   â”‚   â””â”€â”€ agent_service.go  #       Agentä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ repository/           #     æ•°æ®è®¿é—®å±‚ âœ…
â”‚   â”‚       â””â”€â”€ agent_repo.go     #       Agentæ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ config/config.go          #   é…ç½®ç®¡ç† âœ…
â”‚   â”œâ”€â”€ database/database.go      #   æ•°æ®åº“è¿æ¥ âœ…
â”‚   â”œâ”€â”€ models/models.go          #   æ•°æ®æ¨¡å‹ âœ…
â”‚   â”œâ”€â”€ health/health.go          #   å¥åº·æ£€æŸ¥ âœ…
â”‚   â”œâ”€â”€ monitoring/               #   ç›‘æ§æ¨¡å— âœ…
â”‚   â”‚   â”œâ”€â”€ prometheus.go         #     PrometheusæŒ‡æ ‡
â”‚   â”‚   â””â”€â”€ metrics.go            #     æŒ‡æ ‡æ”¶é›†å™¨
â”‚   â”œâ”€â”€ recovery/recovery.go      #   æ•…éšœæ¢å¤ âœ…
â”‚   â””â”€â”€ debug/debug.go           #   è°ƒè¯•å·¥å…· âœ…
â”œâ”€â”€ pkg/                          # å…±äº«å·¥å…·åŒ… âœ…
â”‚   â””â”€â”€ logger/logger.go         #   ç»“æ„åŒ–æ—¥å¿—å·¥å…·
â”œâ”€â”€ proto/                        # gRPCåè®®å®šä¹‰ âœ…
â”‚   â””â”€â”€ agent.proto              #   AgentæœåŠ¡åè®®
â”œâ”€â”€ api/                          # RESTful APIå®šä¹‰ âœ…
â”œâ”€â”€ configs/                      # é…ç½®æ–‡ä»¶ âœ…
â”‚   â”œâ”€â”€ config.yaml              #   Controlleré…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ agent.yaml               #   Agenté…ç½®æ¨¡æ¿
â”‚   â””â”€â”€ sing-box.json            #   sing-boxé…ç½®æ¨¡æ¿
â”œâ”€â”€ scripts/                      # éƒ¨ç½²å’Œå·¥å…·è„šæœ¬ âœ…
â”‚   â”œâ”€â”€ deploy.sh                #   ä¸€é”®éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ init.sql                 #   æ•°æ®åº“åˆå§‹åŒ–
â”‚   â””â”€â”€ generate_proto.sh        #   åè®®ç”Ÿæˆè„šæœ¬
â”œâ”€â”€ monitoring/                   # ç›‘æ§é…ç½® âœ…
â”‚   â””â”€â”€ prometheus.yml           #   Prometheusé…ç½®
â”œâ”€â”€ docs/                         # é¡¹ç›®æ–‡æ¡£ âœ…
â”‚   â”œâ”€â”€ development-plan.md      #   å¼€å‘è®¡åˆ’
â”‚   â”œâ”€â”€ API.md                   #   APIæ–‡æ¡£
â”‚   â””â”€â”€ DEPLOYMENT_GUIDE.md     #   éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ Dockerfile.controller         # Controllerå®¹å™¨é•œåƒ âœ…
â”œâ”€â”€ Dockerfile.agent             # Agentå®¹å™¨é•œåƒ âœ…
â”œâ”€â”€ docker-compose.yml           # å®¹å™¨ç¼–æ’é…ç½® âœ…
â”œâ”€â”€ go.mod                       # Goæ¨¡å—å®šä¹‰ âœ…
â”œâ”€â”€ go.sum                       # Goä¾èµ–æ ¡éªŒ âœ…
â”œâ”€â”€ Makefile                     # æ„å»ºè„šæœ¬ âœ…
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜ âœ…
```

**å›¾ä¾‹**ï¼šâœ… å·²å®Œæˆå¹¶å¯ç”¨äºç”Ÿäº§ç¯å¢ƒ

---

## æŠ€æœ¯å€ºåŠ¡å’Œä¼˜åŒ–

### æŠ€æœ¯å€ºåŠ¡
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ·»åŠ é›†æˆæµ‹è¯•
- [ ] ä¼˜åŒ–é”™è¯¯å¤„ç†
- [ ] æ·»åŠ ä»£ç æ–‡æ¡£

### æ€§èƒ½ä¼˜åŒ–
- [ ] æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
- [ ] gRPCè¿æ¥å¤ç”¨
- [ ] ç¼“å­˜æœºåˆ¶å®ç°
- [ ] å¹¶å‘æ€§èƒ½ä¼˜åŒ–

### å®‰å…¨å¢å¼º
- [ ] JWTè®¤è¯å®ç°
- [ ] TLSè¯ä¹¦ç®¡ç†
- [ ] APIé™æµå®ç°
- [ ] è¾“å…¥éªŒè¯åŠ å¼º